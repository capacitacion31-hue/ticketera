<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdvisorService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ticketero API</a> &gt; <a href="index.source.html" class="el_package">com.example.ticketero.service</a> &gt; <span class="el_source">AdvisorService.java</span></div><h1>AdvisorService.java</h1><pre class="source lang-java linenums">package com.example.ticketero.service;

import com.example.ticketero.model.dto.request.AdvisorStatusRequest;
import com.example.ticketero.model.dto.response.AdvisorResponse;
import com.example.ticketero.model.dto.response.AdvisorStatsResponse;
import com.example.ticketero.model.dto.response.AdvisorStatusChangeResponse;
import com.example.ticketero.model.entity.Advisor;
import com.example.ticketero.model.enums.AdvisorStatus;
import com.example.ticketero.repository.AdvisorRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

@Service
@RequiredArgsConstructor
<span class="fc" id="L21">@Slf4j</span>
@Transactional(readOnly = true)
public class AdvisorService {

    private final AdvisorRepository advisorRepository;
    private final AuditService auditService;

    public List&lt;AdvisorResponse&gt; getAllAdvisors() {
<span class="fc" id="L29">        return advisorRepository.findAll()</span>
<span class="fc" id="L30">            .stream()</span>
<span class="fc" id="L31">            .map(this::toResponse)</span>
<span class="fc" id="L32">            .toList();</span>
    }

    public List&lt;AdvisorResponse&gt; getAvailableAdvisors() {
<span class="fc" id="L36">        return advisorRepository.findByStatus(AdvisorStatus.AVAILABLE)</span>
<span class="fc" id="L37">            .stream()</span>
<span class="fc" id="L38">            .map(this::toResponse)</span>
<span class="fc" id="L39">            .toList();</span>
    }

    @Transactional
    public AdvisorStatusChangeResponse changeStatus(Long advisorId, AdvisorStatusRequest request) {
<span class="fc" id="L44">        Advisor advisor = advisorRepository.findById(advisorId)</span>
<span class="fc" id="L45">            .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Advisor not found: &quot; + advisorId));</span>

<span class="fc" id="L47">        AdvisorStatus previousStatus = advisor.getStatus();</span>
<span class="fc" id="L48">        advisor.setStatus(request.status());</span>
        
        // Reset workload si cambia a AVAILABLE
<span class="fc bfc" id="L51" title="All 2 branches covered.">        if (request.status() == AdvisorStatus.AVAILABLE) {</span>
<span class="fc" id="L52">            advisor.setWorkloadMinutes(0);</span>
<span class="fc" id="L53">            advisor.setAssignedTicketsCount(0);</span>
        }

<span class="fc" id="L56">        Advisor saved = advisorRepository.save(advisor);</span>
        
        // Auditoría
<span class="fc" id="L59">        auditService.logAdvisorStatusChanged(saved, previousStatus, request.reason());</span>
        
<span class="fc" id="L61">        log.info(&quot;Advisor {} status changed from {} to {}&quot;, </span>
<span class="fc" id="L62">            advisor.getName(), previousStatus, request.status());</span>

<span class="fc" id="L64">        return new AdvisorStatusChangeResponse(</span>
<span class="fc" id="L65">            saved.getId(),</span>
<span class="fc" id="L66">            saved.getName(),</span>
<span class="fc" id="L67">            saved.getStatus(),</span>
            previousStatus,
<span class="fc" id="L69">            LocalDateTime.now(),</span>
            &quot;system&quot;, // En producción obtener del contexto de seguridad
<span class="fc" id="L71">            request.reason()</span>
        );
    }

    public AdvisorStatsResponse getAdvisorStats(Long advisorId) {
<span class="fc" id="L76">        Advisor advisor = advisorRepository.findById(advisorId)</span>
<span class="fc" id="L77">            .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Advisor not found: &quot; + advisorId));</span>

        // Placeholder - implementar cálculos reales de estadísticas
<span class="fc" id="L80">        AdvisorStatsResponse.AdvisorPerformance performance = </span>
            new AdvisorStatsResponse.AdvisorPerformance(
<span class="fc" id="L82">                advisor.getTotalTicketsServedToday(),</span>
<span class="fc" id="L83">                advisor.getAverageServiceTimeMinutes().doubleValue(),</span>
<span class="fc" id="L84">                15.0, // Tiempo estimado promedio</span>
<span class="fc" id="L85">                93.0, // Accuracy</span>
                &quot;ABOVE_AVERAGE&quot;
            );

<span class="fc" id="L89">        List&lt;AdvisorStatsResponse.TicketDetail&gt; ticketDetails = List.of(</span>
            new AdvisorStatsResponse.TicketDetail(
<span class="fc" id="L91">                &quot;C01&quot;, &quot;CAJA&quot;, 5, 4, &quot;-20%&quot;, &quot;FASTER&quot;</span>
            )
        );

<span class="fc" id="L95">        return new AdvisorStatsResponse(</span>
<span class="fc" id="L96">            advisor.getId(),</span>
<span class="fc" id="L97">            advisor.getName(),</span>
<span class="fc" id="L98">            LocalDate.now(),</span>
            performance,
            ticketDetails
        );
    }

    private AdvisorResponse toResponse(Advisor advisor) {
<span class="fc" id="L105">        return new AdvisorResponse(</span>
<span class="fc" id="L106">            advisor.getId(),</span>
<span class="fc" id="L107">            advisor.getName(),</span>
<span class="fc" id="L108">            advisor.getEmail(),</span>
<span class="fc" id="L109">            advisor.getStatus(),</span>
<span class="fc" id="L110">            advisor.getModuleNumber(),</span>
<span class="fc" id="L111">            advisor.getAssignedTicketsCount(),</span>
<span class="fc" id="L112">            advisor.getWorkloadMinutes(),</span>
<span class="fc" id="L113">            advisor.getAverageServiceTimeMinutes(),</span>
<span class="fc" id="L114">            advisor.getTotalTicketsServedToday(),</span>
<span class="fc" id="L115">            advisor.getQueueTypes(),</span>
<span class="fc" id="L116">            advisor.getLastAssignedAt(),</span>
<span class="fc" id="L117">            LocalDateTime.now() // statusSince - placeholder</span>
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>